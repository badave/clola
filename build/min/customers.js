$(function(){if($.cookie("last_phone_lookup")&&$("#phone").val($.cookie("last_phone_lookup")),$(document).on("submit","#lookup",function(a){a.preventDefault(),a.stopPropagation();var b=$("#phone").val().replace(/\D/g,"");$.cookie("last_phone_lookup",b),$("#lookup-btn").val("Looking up...").attr("disabled","disabled"),0===$("#"+b).length?(customer=new Customer({phone:b}),customer.fetch({success:function(a){$("#lookup-btn").val("Found").removeAttr("disabled"),setTimeout(function(){$("#lookup-btn").val("Go")},3e3),customer=a,customer.id||customer.save(),customer.cv=new CustomerView({model:customer}),customer.cv.render()},error:function(a){$("#lookup-btn").val("Retry").removeAttr("disabled"),console.log("Error with",a),console.log("Please render an error")}})):$("body").animate({scrollTop:$("#"+b).offset().top})}),Customer=Backbone.Model.extend({idAttribute:"_id",url:function(){return this.urlRoot+"/"+this.get("phone")},urlRoot:"/v1/customers",buildObject:function(a){var b={},c=this;return $(a).each(function(a,d){var e=$("#"+c.id+" ."+d).val();""!==e&&(b[d]=e)}),b},updateValues:function(a){this.save(this.buildObject(["name","email","gender","age"]),{success:a})},addLocation:function(a,b){var c=this.get("previous_locations")||[];a.updated=(new Date).getTime(),a.updated_date=new Date,c.unshift(a),this.set("previous_locations",c),this.save({},{success:b})}}),CustomerView=Backbone.View.extend({el:".customers",events:{"click .update":"saveInfo","click .add-location":"addLocation"},template:_.template($("#customer").html()),render:function(){this.$el.append(this.template({data:this.model.toJSON()})),this.placesView=new PlacesView({el:"#"+this.model.id+" .find-place",collection:all_places,customer:this.model}),this.placesView.renderFinder()},saveInfo:function(a){a.stopPropagation(),a.preventDefault();var b=this;return $("#"+this.model.id+" .update").val("Updating..."),this.model.updateValues(function(){$("#"+b.model.id+" .update").val("Updated"),setTimeout(function(){$("#"+b.model.id+" .update").val("Update")},3e3)}),!1},addLocation:function(a){a.stopPropagation(),a.preventDefault();var b=this;$("#"+this.model.id+" .add-location").val("Updating...");var c=$("#location-form").serializeArray(),d={};return _.each(c,function(a){d[a.name]=a.value}),this.model.addLocation(d,function(){$(".location-form input").each(function(a,b){$(b).val("")}),$("#"+b.model.id+" .add-location").val("Updated");var a=_.template($("#location-template").html());$("#"+b.model.id+" .previous-locations").prepend(a({location:b.model.get("previous_locations")[0]})),setTimeout(function(){$("#"+b.model.id+" .add-location").val("Add Location")},3e3)}),!1}}),$(document).on("click","#add_location_btn",function(){var a={city:$("#place-city").val(),area:$("#place-area").val(),category:$("#place-category").val(),subcategory:$("#place-subcategory").val(),name:$("#place-name").val(),description:$("#place-description").val(),address:$("#place-address").val(),contact:$("#place-contact").val(),hours:$("#place-hours").val()};for(var b in a)a[b]=a[b].trim();var c=new Place(a);c.save(),all_places.add(c),_.each($("#places-modal input"),function(a){$(a).val("")}),$("#places-modal").modal("hide")}),Place=Backbone.Model.extend({idAttribute:"_id",urlRoot:"/v1/places"}),Places=Backbone.Collection.extend({model:Place,getPlaces:function(a){return _.filter(this.models,function(b){return _.contains(a,b.get("city"))})},getAreas:function(a){return _.map(a,function(a){return a.get("area")})},getCategories:function(a){return _.map(a,function(a){return a.get("category")})},getSubcategories:function(a){return _.map(a,function(a){return a.get("subcategory")})},url:function(){return"/v1/places"},cities:function(){return _.uniq(_.map(this.models,function(a){return a.get("city")}))}}),PlacesView=Backbone.View.extend({initialize:function(){var a=this;this.collection.on("add",function(b){a.findAreas(b)})},events:{'change [name="city"]':"findAreas",'change [name="area"]':"findCategories",'change [name="category"]':"findSubcategories",'change [name="subcategory"]':"find","click .send-btn":"addLocation"},find_template:_.template($("#find-place-template").html()),template:_.template($("#place-template").html()),find_area_template:_.template('<% _.each(areas, function(area, idx) { %> 						<input id="find-area-<%= idx %>" name="area" type="checkbox" value="<%= area %>" class="toggle"></input> 								<label for="find-area-<%= idx %>" class="btn btn-large"><%= area %></label> 						<% }) %>'),find_category_template:_.template('<% _.each(categories, function(category, idx) { %> 						<input id="find-category-<%= idx %>" name="category" type="checkbox" value="<%= category %>" class="toggle"></input> 								<label for="find-category-<%= idx %>" class="btn btn-large"><%= category %></label> 						<% }) %>'),find_subcategory_template:_.template('<% _.each(subcategories, function(subcategory, idx) { %> 						<input id="find-subcategory-<%= idx %>" name="subcategory" type="checkbox" value="<%= subcategory %>" class="toggle"></input> 								<label for="find-subcategory-<%= idx %>" class="btn btn-large"><%= subcategory %></label> 						<% }) %>'),addLocation:function(a){if(this.options.customer){var b=this.collection.findWhere({_id:$(a.target).attr("data-id")}),c={name:b.get("name"),address:b.get("address"),notes:b.get("description")};this.options.customer.addLocation(c);var d=_.template($("#location-template").html());$("#"+this.options.customer.id+" .previous-locations").prepend(d({location:c}))}},getSelectedAreas:function(){return _.map(this.$el.find(".places-areas input:checked"),function(a){return $(a).val()})},getSelectedCities:function(){return _.map(this.$el.find(".places-cities input:checked"),function(a){return $(a).val()})},getSelectedCategories:function(){return _.map(this.$el.find(".places-categories input:checked"),function(a){return $(a).val()})},getSelectedSubcategories:function(){return _.map(this.$el.find(".places-subcategories input:checked"),function(a){return $(a).val()})},findAreas:function(){var a=this.getSelectedCities(),b=this.collection.getPlaces(a),c=this.collection.getAreas(b);unique_areas=_.uniq(c);var d=this.find_area_template({areas:unique_areas});this.$el.find(".places-areas").html(d),this.$el.find(".places-categories").html(""),this.$el.find(".places-subcategories").html(""),$(".places").html(""),this.delegateEvents()},findCategories:function(){var a=this.getSelectedCities(),b=this.getSelectedAreas(),c=_.filter(this.collection.getPlaces(a),function(a){return _.contains(b,a.get("area"))});if(b.length>0){var d=this.collection.getCategories(c),e=_.uniq(d),f=this.find_category_template({categories:e});this.$el.find(".places-categories").html(f),this.$el.find(".places-subcategories").html(""),$(".places").html(""),this.delegateEvents()}else this.$el.find(".places-categories").html(""),this.$el.find(".places-subcategories").html(""),$(".places").html("")},findSubcategories:function(){var a=this.getSelectedCities(),b=this.getSelectedAreas(),c=this.getSelectedCategories(),d=_.filter(this.collection.getPlaces(a),function(a){return _.contains(b,a.get("area"))&&_.contains(c,a.get("category"))});if(c.length>0){var e=this.collection.getSubcategories(d),f=_.uniq(e),g=this.find_subcategory_template({subcategories:f});this.$el.find(".places-subcategories").html(g),this.delegateEvents()}else this.$el.find(".places-subcategories").html(""),$(".places").html("")},find:function(){var a=this.getSelectedCities(),b=this.getSelectedAreas(),c=this.getSelectedCategories(),d=this.getSelectedSubcategories();if(d.length>0){var e=_.filter(this.collection.getPlaces(a),function(a){return _.contains(b,a.get("area"))&&_.contains(c,a.get("category"))&&_.contains(d,a.get("subcategory"))});e.length>0&&this.renderPlaces(e)}else $(".places").html("")},renderPlaces:function(a){var b,c=this,d="";this.options.customer&&(b=this.options.customer.toJSON()),_.each(a,function(a){d+=c.template({place:a.toJSON(),customer:b})}),$(".places").html(d)},renderFinder:function(){var a=this.collection.cities(),b=this.find_template({cities:a});$(".find-places").html(b),this.$el=$(".find-places .find-place"),this.delegateEvents()}}),all_places=new Places,all_places.fetch({success:function(a){"function"==typeof afterPlacesLoaded&&afterPlacesLoaded(a)}}),$(".messages-container").length>0){var a=io.connect("http://clola.herokuapp.com:80/");a.on("msg",function(a){b.add(a)}),a.on("replying",function(a){$("#"+a.phone+".message-group").addClass("replying"),$("#"+a.phone+" .reply").val(a.reply)}),Message=Backbone.Model.extend({idAttribute:"_id",urlRoot:"/v1/messages"}),Messages=Backbone.Collection.extend({model:Message,url:function(){return"/v1/messages"}}),MessageView=Backbone.View.extend({messages_template:_.template($("#messages").html()),message_template:_.template($("#message").html()),events:{"keyup .reply":"replying","click .send-reply":"sendReply","click .show-reply":"showReply","click .hide-msgs":"hide"},hide:function(){a.emit("hide",{phone:this.model.get("phone")})},replying:function(b){var c=this.$el.find(".message-group").addClass("replying").find(".reply");a.emit("replying",{phone:$(b.target).attr("data-phone"),reply:$(c).val()})},sendReply:function(){var b=this.$el.find(".reply");""!==$(b).val()&&(this.$el.find(".message-group").removeClass("replying"),a.emit("reply",{phone:$(b).attr("data-phone"),message:{text:$(b).val(),reply:!0,created:(new Date).getTime()}}))},showReply:function(a){this.$el.find(".reply-group").show(),$(a.target).hide()},render:function(){var a=this.model.get("phone"),b=this.messages_template,c=b({data:this.model.toJSON()});$(".messages-container").append(c),this.el="#"+a,this.$el=$("#"+a),this.delegateEvents(),this.updateOffsets(this.model.get("status"))},add:function(a){var b=this.model.get("messages");b.push(a.get("messages")),this.model.set("messages",b),this.model.set("status",a.get(status));var c=this;this.model.get("phone"),_.each(a.get("messages"),function(a){c.$el.find(".msgs").append(c.message_template({message:a}))}),this.$el.find(".status").text(a.get("status")),this.updateOffsets(a.get("status"))},updateOffsets:function(a){"new"===a&&this.$el.closest(".msg-container").removeClass("offset6").show(),"replied"===a&&this.$el.closest(".msg-container").addClass("offset6").show(),"hidden"===a&&this.$el.closest(".msg-container").hide()}});var b=new Messages;b.fetch(),b.on("add",function(a){this.mv=this.mv||{};var b=a.get("phone");this.mv[b]?this.mv[b].add(a):(this.mv[b]=new MessageView({model:a}),this.mv[b].render())})}});